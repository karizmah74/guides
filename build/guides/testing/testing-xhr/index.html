
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Ember.js - Guides</title>
    <meta property="st:title" content="Guides" />
    <link rel="shortcut icon" href="/images/favicon.png" />
    <!--[if lte IE 7 ]><link href="../../../stylesheets/fonts/fontello-ie7.css" rel="stylesheet" type="text/css" /><![endif]-->
    <link href="../../../stylesheets/site.css" rel="stylesheet" type="text/css" />
    <link href="/blog/feed.xml" rel="alternate" type="application/atom+xml" title="Ember.js - Blog" />
    
  </head>

  <body class="guides guides_testing guides_testing_testing-xhr guides_testing_testing-xhr_index">

    <script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
    <script src="//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js" type="text/javascript"></script>

    <!--[if lt IE 9]>
      <script type="text/javascript" src="/javascripts/common-old-ie.js"></script>
    <![endif]-->
    <!--[if gte IE 9]><!-->
      <script type="text/javascript" src="/javascripts/common-modern.js"></script>
    <!--<![endif]-->

    <div id="header">
      <div id="wrapper">
        <a id="logo" href="/">&nbsp;</a>
        <ul id="nav">
          <li><a href="/about">about</a></li>
          <li class="active"><a href="/guides">guides</a></li>
          <li><a href="/api">api</a></li>
          <li><a href="/community">community</a></li>
          <li><a href="/blog">blog</a></li>
          <li><a href="/builds">builds</a></li>
          <li id="search">
            <form>
              <input type="text" id="st-search-input" class="st-search-input" />
            </form>
            <div id="st-results-container"></div>
          </li>
        </ul>

        <div id="github">
          <a href="https://github.com/emberjs/ember.js"><i class="icon-fork"></i>Fork Us!</a>
        </div>
      </div>
    </div>

    

    <div id="content-wrapper">
        <div id="sidebar">
              <ol id="toc-list">
          <li class="level-1">
            <a href="../../getting-started/">Getting Started</a>
            <ol>
        
            <li class="level-3">
              <a href="../../getting-started/">Getting Started</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/planning-the-application/">Planning The Application</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/creating-a-static-mockup/">Creating a Static Mockup</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/obtaining-emberjs-and-dependencies/">Obtaining Ember.js and Dependencies</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/adding-a-route-and-template/">Adding the First Route and Template</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/modeling-data/">Modeling Data</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/using-fixtures/">Using Fixtures</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/displaying-model-data/">Displaying Model Data</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/displaying-a-models-completeness/">Displaying a Model's Complete State</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/creating-a-new-model/">Creating a New Model Instance</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/marking-a-model-as-complete-incomplete/">Marking a Model as Complete or Incomplete</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/displaying-the-number-of-incomplete-todos/">Displaying the Number of Incomplete Todos</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/toggle-todo-editing-state/">Toggling between Showing and Editing States</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/accepting-edits/">Accepting Edits</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/deleting-todos/">Deleting a Model</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/adding-child-routes/">Adding Child Routes</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/show-only-incomplete-todos/">Transitioning to Show Only Incomplete Todos</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/show-only-complete-todos/">Transitioning to Show Only Complete Todos</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/show-all-todos-again/">Transitioning back to Show All Todos</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/display-a-button-to-remove-completed-todos/">Displaying a Button to Remove All Completed Todos</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/show-when-all-todos-are-complete/">Indicating When All Todos Are Complete</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/toggle-all-todos/">Toggling All Todos Between Complete and Incomplete</a>
            </li>
          
            <li class="level-3">
              <a href="../../getting-started/using-other-adapters/">Replacing the Fixture Adapter with Another Adapter</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../getting-ember/">Getting Ember</a>
            <ol>
        
            <li class="level-3">
              <a href="../../getting-ember/">Getting Ember</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../concepts/core-concepts/">Concepts</a>
            <ol>
        
            <li class="level-3">
              <a href="../../concepts/core-concepts/">Core Concepts</a>
            </li>
          
            <li class="level-3">
              <a href="../../concepts/naming-conventions/">Naming Conventions</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../object-model/classes-and-instances/">The Object Model</a>
            <ol>
        
            <li class="level-3">
              <a href="../../object-model/classes-and-instances/">Classes and Instances</a>
            </li>
          
            <li class="level-3">
              <a href="../../object-model/computed-properties/">Computed Properties</a>
            </li>
          
            <li class="level-3">
              <a href="../../object-model/computed-properties-and-aggregate-data/">Computed Properties and Aggregate Data with @each</a>
            </li>
          
            <li class="level-3">
              <a href="../../object-model/observers/">Observers</a>
            </li>
          
            <li class="level-3">
              <a href="../../object-model/bindings/">Bindings</a>
            </li>
          
            <li class="level-3">
              <a href="../../object-model/reopening-classes-and-instances/">Reopening Classes and Instances</a>
            </li>
          
            <li class="level-3">
              <a href="../../object-model/what-do-i-use-when/">Bindings, Observers, Computed Properties: What Do I Use When?</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../application/">Application</a>
            <ol>
        
            <li class="level-3">
              <a href="../../application/">Introduction</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../templates/the-application-template/">Templates</a>
            <ol>
        
            <li class="level-3">
              <a href="../../templates/the-application-template/">The Application Template</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/handlebars-basics/">Handlebars Basics</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/conditionals/">Conditionals</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/displaying-a-list-of-items/">Displaying a List of Items</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/binding-element-attributes/">Binding Element Attributes</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/binding-element-class-names/">Binding Element Class Names</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/links/">Links</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/actions/">Actions</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/input-helpers/">Input Helpers</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/development-helpers/">Development Helpers</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/rendering-with-helpers/">Rendering with Helpers</a>
            </li>
          
            <li class="level-3">
              <a href="../../templates/writing-helpers/">Writing Helpers</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../routing/">Routing</a>
            <ol>
        
            <li class="level-3">
              <a href="../../routing/">Introduction</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/defining-your-routes/">Defining Your Routes</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/generated-objects/">Generated Objects</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/specifying-a-routes-model/">Specifying a Route's Model</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/setting-up-a-controller/">Setting Up a Controller</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/rendering-a-template/">Rendering a Template</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/redirection/">Redirecting</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/specifying-the-location-api/">Specifying the URL Type</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/query-params/">Query Parameters</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/asynchronous-routing/">Asynchronous Routing</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/loading-and-error-substates/">Loading / Error Substates</a>
            </li>
          
            <li class="level-3">
              <a href="../../routing/preventing-and-retrying-transitions/">Preventing and Retrying Transitions</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../components/">Components</a>
            <ol>
        
            <li class="level-3">
              <a href="../../components/">Introduction</a>
            </li>
          
            <li class="level-3">
              <a href="../../components/defining-a-component/">Defining a Component</a>
            </li>
          
            <li class="level-3">
              <a href="../../components/passing-properties-to-a-component/">Passing Properties to a Component</a>
            </li>
          
            <li class="level-3">
              <a href="../../components/wrapping-content-in-a-component/">Wrapping Content in a Component</a>
            </li>
          
            <li class="level-3">
              <a href="../../components/customizing-a-components-element/">Customizing a Component's Element</a>
            </li>
          
            <li class="level-3">
              <a href="../../components/handling-user-interaction-with-actions/">Handling User Interaction with Actions</a>
            </li>
          
            <li class="level-3">
              <a href="../../components/sending-actions-from-components-to-your-application/">Sending Actions from Components to Your Application</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../controllers/">Controllers</a>
            <ol>
        
            <li class="level-3">
              <a href="../../controllers/">Introduction</a>
            </li>
          
            <li class="level-3">
              <a href="../../controllers/representing-a-single-model-with-objectcontroller/">Representing a Single Model with ObjectController</a>
            </li>
          
            <li class="level-3">
              <a href="../../controllers/representing-multiple-models-with-arraycontroller/">Representing Multiple Models with ArrayController</a>
            </li>
          
            <li class="level-3">
              <a href="../../controllers/dependencies-between-controllers/">Managing Dependencies Between Controllers</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../models/">Models</a>
            <ol>
        
            <li class="level-3">
              <a href="../../models/">Introduction</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/defining-models/">Defining Models</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/creating-and-deleting-records/">Creating and Deleting Records</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/pushing-records-into-the-store/">Pushing Records into the Store</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/persisting-records/">Persisting Records</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/finding-records/">Finding Records</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/working-with-records/">Working with Records</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/the-fixture-adapter/">Using Fixtures</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/the-rest-adapter/">The Rest Adapter</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/connecting-to-an-http-server/">Connecting to an HTTP Server</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/handling-metadata/">Handling Metadata</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/customizing-adapters/">Customizing Adapters</a>
            </li>
          
            <li class="level-3">
              <a href="../../models/frequently-asked-questions/">Frequently Asked Questions</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../views/">Views</a>
            <ol>
        
            <li class="level-3">
              <a href="../../views/">Introduction</a>
            </li>
          
            <li class="level-3">
              <a href="../../views/defining-a-view/">Defining a View</a>
            </li>
          
            <li class="level-3">
              <a href="../../views/handling-events/">Handling Events</a>
            </li>
          
            <li class="level-3">
              <a href="../../views/inserting-views-in-templates/">Inserting Views in Templates</a>
            </li>
          
            <li class="level-3">
              <a href="../../views/adding-layouts-to-views/">Adding Layouts to Views</a>
            </li>
          
            <li class="level-3">
              <a href="../../views/customizing-a-views-element/">Customizing a View's Element</a>
            </li>
          
            <li class="level-3">
              <a href="../../views/built-in-views/">Built-in Views</a>
            </li>
          
            <li class="level-3">
              <a href="../../views/manually-managing-view-hierarchy/">Manually Managing View Hierarchy</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../enumerables/">Enumerables</a>
            <ol>
        
            <li class="level-3">
              <a href="../../enumerables/">Introduction</a>
            </li>
          </ol></li>
          <li class="level-1 selected">
            <a href="../">Testing</a>
            <ol class='selected'>
        
            <li class="level-3">
              <a href="../">Introduction</a>
            </li>
          
            <li class="level-3">
              <a href="../integration/">Integration Tests</a>
            </li>
          
            <li class="level-3">
              <a href="../test-helpers/">Test Helpers</a>
            </li>
          
            <li class="level-3">
              <a href="../testing-user-interaction/">Testing User Interaction</a>
            </li>
          
            <li class="level-3">
              <a href="../unit-testing-basics/">Unit Testing Basics</a>
            </li>
          
            <li class="level-3">
              <a href="../unit-test-helpers/">Unit Test Helpers</a>
            </li>
          
            <li class="level-3">
              <a href="../testing-components/">Testing Components</a>
            </li>
          
            <li class="level-3">
              <a href="../testing-controllers/">Testing Controllers</a>
            </li>
          
            <li class="level-3">
              <a href="../testing-routes/">Testing Routes</a>
            </li>
          
            <li class="level-3">
              <a href="../testing-models/">Testing Models</a>
            </li>
          
            <li class="level-3">
              <a href="../test-runners/">Automating Tests with Runners</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../configuring-ember/disabling-prototype-extensions/">Configuring Ember.js</a>
            <ol>
        
            <li class="level-3">
              <a href="../../configuring-ember/disabling-prototype-extensions/">Disabling Prototype Extensions</a>
            </li>
          
            <li class="level-3">
              <a href="../../configuring-ember/embedding-applications/">Embedding Applications</a>
            </li>
          
            <li class="level-3">
              <a href="../../configuring-ember/feature-flags/">Feature Flags</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../cookbook/">Cookbook</a>
            <ol>
        
            <li class="level-3">
              <a href="../../cookbook/">Introduction</a>
            </li>
          
            <li class="level-3">
              <a href="/guides/cookbook/contributing.html">Contributing</a>
            </li>
          
            <li class="level-3">
              <a href="/guides/cookbook/user_interface_and_interaction.html">User Interface and Interaction</a>
            </li>
          
            <li class="level-3">
              <a href="/guides/cookbook/event_handling_and_data_binding.html">Event Handling & Data Binding</a>
            </li>
          
            <li class="level-3">
              <a href="/guides/cookbook/helpers_and_components.html">Helpers & Components</a>
            </li>
          
            <li class="level-3">
              <a href="/guides/cookbook/working_with_objects.html">Working with Objects</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="/guides/deprecations.html">Deprecations</a>
            <ol>
        
            <li class="level-3">
              <a href="/guides/deprecations.html">Deprecations/index</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../understanding-ember/the-view-layer/">Understanding Ember.js</a>
            <ol>
        
            <li class="level-3">
              <a href="../../understanding-ember/the-view-layer/">The View Layer</a>
            </li>
          
            <li class="level-3">
              <a href="../../understanding-ember/managing-asynchrony/">Managing Asynchrony</a>
            </li>
          
            <li class="level-3">
              <a href="../../understanding-ember/keeping-templates-up-to-date/">Keeping Templates Up-to-Date</a>
            </li>
          
            <li class="level-3">
              <a href="../../understanding-ember/debugging/">Debugging</a>
            </li>
          
            <li class="level-3">
              <a href="../../understanding-ember/run-loop/">The Run Loop</a>
            </li>
          
            <li class="level-3">
              <a href="../../understanding-ember/dependency-injection-and-service-lookup/">Dependency Injection & Service Lookup</a>
            </li>
          </ol></li>
          <li class="level-1">
            <a href="../../contributing/adding-new-features/">Contributing to Ember.js</a>
            <ol>
        
            <li class="level-3">
              <a href="../../contributing/adding-new-features/">Adding New Features</a>
            </li>
          
            <li class="level-3">
              <a href="../../contributing/repositories/">Repositories</a>
            </li>
          </ol></li></ol>

          <div id="back-to-top"><a id="back-top-top" href="#">&#11014; Back to Top</a></div>
        </div>
      <div id="content" class="has-sidebar">
        
  <div class="chapter">
    
    <hr>
    <p>Testing with asynchronous calls and promises in Ember may seem tricky at first, but with a little explanation things should become clearer.</p>
<h3 class='anchorable-toc' id='toc_promises-ember-and-the-run-loop'>Promises, Ember and the Run Loop</h3>
<p>In order to fully explain testing promises &amp; asynchronous code, it&#39;s important that you have a clear grasp of the Ember run loop. If you haven&#39;t yet done so, please read about them in the <a href="/api/classes/Ember.RSVP.Promise.html">Promises</a> and <a href="/guides/understanding-ember/run-loop/">Understanding Ember run loop guide</a>.</p>

<p>Now that you grasp the general concepts regarding the run loop, recall from reading about the basics of testing Ember applications that the run loop is suspended when in testing mode.  This helps ensure the procedure of your code and the tests you write around that code. Note that in testing promises and asynchronous code, you&#39;re effectively &quot;stepping through&quot; your application in chunks.</p>

<p>When a promise runs, it schedules fulfillment/rejection to be executed by the run loop, therefore in order for promises to work the run loop must be on. In short: no run loop, no promise fulfillment/rejection.</p>

<p>Getting the results of a promise requires you to use the <code>then</code> method. Calling the <code>then</code> function on an existing promise:</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
</pre></td>
  <td class="code"><pre><span class="comment">// let's call the existing promise promise1, so you'd write:</span>
promise1.then(fulfillmentCallback, rejectionCallback);

<span class="keyword">function</span> <span class="function">fulfillmentCallback</span>(successfulResults) {
  <span class="comment">// do something wonderful with the results</span>
}

<span class="keyword">function</span> <span class="function">rejectionCallback</span>(failureResults) {
  <span class="comment">// tell someone important about the failure</span>
}
</pre></td>
</tr></table>
</div></div>
<p>In the case that <code>promise1</code> succeeds, then the <code>fulfillmentCallback</code> function will be called and passed the successful results of <code>promise1</code> as its argument. If the promise rejects (ie failure), then the <code>rejectionCallback</code> will be called with the failure reason as its argument.</p>

<p>If you pass in a function to <code>then</code> it casts the function into a promise and returns the promise.  The results of that promise will be what&#39;s returned from the function.</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
24
25
</pre></td>
  <td class="code"><pre><span class="comment">// let's call the existing promise promise1 and will have the result `3`, so you'd write:</span>
<span class="keyword">var</span> promise2 = promise1.then(<span class="keyword">function</span>(results){
  <span class="keyword">return</span> results + <span class="integer">2</span>;
});

<span class="comment">// the results of this promise would be 10</span>
<span class="keyword">var</span> promise3a = promise2.then(<span class="keyword">function</span>(results){
  <span class="keyword">return</span> results + <span class="integer">5</span>;
});

<span class="comment">// the results of this promise would be 6</span>
<span class="keyword">var</span> promise3b = promise2.then(<span class="keyword">function</span>(results){
 <span class="keyword">return</span> results + <span class="integer">1</span>;
});

<span class="comment">// or we can chain without the intermediary variables like so,</span>
<span class="keyword">var</span> promise4 = promise1.then(<span class="keyword">function</span>(results){
  <span class="keyword">return</span> results + <span class="integer">2</span>;
}).then(<span class="keyword">function</span>(results){
  <span class="keyword">return</span> results + <span class="integer">5</span>;
}).then(<span class="keyword">function</span>(results){
  <span class="keyword">return</span> results + <span class="integer">90</span>;
}).then(<span class="keyword">function</span>(results){
  alert(results); <span class="comment">// this will alert `100`</span>
});
</pre></td>
</tr></table>
</div></div>
<p>If you pass a promise into <code>then</code> it will return the results of that promise.</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre><span class="comment">// let's call the existing promises promise1 and promise2, so you'd write:</span>
<span class="keyword">var</span> promise3 = promise1.then(promise2);

promise3.then(<span class="keyword">function</span>(result){
  <span class="comment">// this will be the results from promise2</span>
  <span class="comment">// this callback won't be called until promise1 and promise2 have fulfilled</span>
  alert(result);
});
</pre></td>
</tr></table>
</div></div>
<p><em>**None of this will work if the run loop isn&#39;t running due to these callbacks and/or chained promises getting scheduled on the run loop.  *</em>*</p>
<h3 class='anchorable-toc' id='toc_where-the-run-loop-and-promises-intersect'>Where the run loop and Promises intersect</h3><h4 class='anchorable-toc' id='toc_promise-resolution'>Promise Resolution</h4><div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>var promise = new Ember.RSVP.Promise(function(resolve){
  // calling resolve will schedule an action to fulfill the promise 
  // and call observers/chained promises.
  resolve('hello world'); // Run loop needs to be on here
});
</pre></td>
</tr></table>
</div></div><h4 class='anchorable-toc' id='toc_chaining-observing-promises'>Chaining/Observing Promises</h4><div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>// once the above promise has been resolved it will then notify 
// the observers/chained promises to.
promise.then(function(result){  // Run loop might* need to be on here
  alert(result);
});
</pre></td>
</tr></table>
</div></div>
<ul>
<li>Calling <code>then</code> (observing/chaining) only needs to be implicitely wrapped in a run call statement (eg <code>Ember.run(...)</code>) if there is a possibility you will chain/observe the promise after it&#39;s been fulfilled.  See the examples below which will help explain the different scenarios.</li>
</ul>
<h5 class='anchorable-toc' id='toc_walk-through-example-of-observing-chaining-before-the-promise-has-fulfilled'>Walk through example of observing/chaining before the promise has fulfilled</h5>
<ol>
<li>Run loop is off (testing mode)</li>
<li>Code: Create Promise1 (new Ember.RSVP.Promise....)</li>
<li>Code: Observe Promise1 (promise.then(....))</li>
<li>Code: Begin run loop (this will only finish once the run loop has cleared out all of the scheduled items)</li>
<li>Code: Resolve Promise1 (this will scheduled a task in the run loop to fulfill the promise)</li>
<li>Run loop: run &quot;fulfill the promise&quot; task (which includes notifying all chained promises/observers of fulfillment)</li>
<li>Run loop is off since there are no more tasks</li>
</ol>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre><span class="keyword">new</span> Ember.RSVP.Promise(<span class="keyword">function</span>(resolve){
  <span class="comment">// resolve will run ~10 ms after the then has been called and is observing</span>
  Ember.run.later(<span class="local-variable">this</span>, resolve, <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">10</span>);
}).then(<span class="keyword">function</span>(result){
  alert(result);
});
</pre></td>
</tr></table>
</div></div><h5 class='anchorable-toc' id='toc_walk-through-example-of-observing-chaining-after-the-promise-has-fulfilled'>Walk through example of observing/chaining after the promise has fulfilled</h5>
<ol>
<li>Run loop is off (testing mode)</li>
<li>Code: Create Promise1</li>
<li>Code: Begin run loop (this will finish once all scheduled tasks have been executed)</li>
<li>Code: Resolve Promise1 (this will add a scheduled task to fulfill the promise)</li>
<li>Run loop: run &quot;fulfill the promise&quot; task (which includes notifying all chained promises/observers of fulfillment)</li>
<li>Run loop is off since there are no more tasks</li>
<li>Code: Observe Promise1 (since the promise has already fulfilled, schedule an async task to notify this observer of fulfillment)</li>
<li>Uncaught Error: Assertion Failed: You have turned on testing mode, which disabled the run-loop&#39;s autorun. You will need to wrap any code with asynchronous side-effects in an Ember.run</li>
</ol>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
</pre></td>
  <td class="code"><pre><span class="keyword">var</span> promise = <span class="keyword">new</span> Ember.RSVP.Promise(<span class="keyword">function</span>(resolve){
  <span class="comment">// this will run before the then has happened below</span>
  <span class="comment">// and finish the triggered run loop</span>
  Ember.run(<span class="local-variable">this</span>, resolve, <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>);
});

<span class="comment">// incorrect the run loop isn't on any more</span>
promise.then(<span class="keyword">function</span>(result){
  alert(result);
});

<span class="comment">// correct, start the run loop again</span>
Ember.run(<span class="keyword">function</span>(){
  promise.then(<span class="keyword">function</span>(result){
    alert(result);
  });
});
</pre></td>
</tr></table>
</div></div><h3 class='anchorable-toc' id='toc_testing-promises-and-the-run-loop'>Testing promises and the run loop</h3>
<p>When you are using Ember normally (ie when not in testing mode), the run loop is actively running, so you don&#39;t need to worry about wrapping these events in calls to Ember.run(). In testing mode, the run loop is passive and must be triggered manually.  Testing asynchronous code not wrapped in calls to Ember.run will result in the error: <code>Uncaught Error: Assertion Failed: You have turned on testing mode, which disabled the run-loop&#39;s autorun. You will need to wrap any code with asynchronous side-effects in an Ember.run</code>.</p>
<h4 class='anchorable-toc' id='toc_general-example'>General Example</h4>
<p>Here we are setting up a promise, and intentionally using <code>setTimeout</code> to mimic a delayed response from a fake server.  Once our fake server has responded we need to invoke the run loop manually, by wrapping the statement in a run call.</p>
<div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>var promise = new Ember.RSVP.Promise(function(resolve){
  setTimeout(function(){
    Ember.run(this, resolve, 'hello world');
  }, 20);
});
</pre></td>
</tr></table>
</div></div>
<p>If you were to pass the above promise around to multiple methods, and they choose to observe/chain to the promise, it is likely that at some point the promise may already be resolved.  In that case you will need to wrap the observer/chained promise in a run call.</p>
<div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>Ember.run(function(){
  promise.then(function(result){
    alert(result);
  });
});
</pre></td>
</tr></table>
</div></div><h4 class='anchorable-toc' id='toc_synchronous-example-using-promises'>Synchronous Example using promises</h4>
<p>If you&#39;re using a promise, but it resolves immediately then you can simply follow the pattern above of wrapping the resolve and observer/chained promises in a run call without harm.  In this example we wrap the resolve and the observer (due to the promise resolving immediately) in a run call.</p>

<script src="http://static.jsbin.com/js/embed.js"></script>

<p><a class="jsbin-embed" href="http://jsbin.com/qoyinucu/45/embed?js,output">Simple promise example</a></p>
<h4 class='anchorable-toc' id='toc_asynchronous-example-using-promises'>Asynchronous Example using promises</h4>
<p>If you&#39;re using a promise, but there&#39;s a chance it might resolves after the test would finish you&#39;ll need to use the <code>stop</code> and <code>start</code> global qunit methods.  These methods will give you the ability to tell qunit to stop the test run on the current test (makes qunit wait) and start again when ready.  In this example we delay execution and wrap the resolve in a run call.  Since the chained promise begins observing before the promise has been resolved you won&#39;t need to wrap  the chained promise in a run call.</p>

<p><a class="jsbin-embed" href="http://jsbin.com/qoyinucu/46/embed?js,output">Async promise example</a></p>
<h2 class='anchorable-toc' id='toc_ajax'>AJAX</h2>
<p>AJAX requests are the most prevelant use case where you will be creating promises.  While testing it&#39;s likely you will want to mock your AJAX requests to the server.  Below we&#39;ve included examples for <a href="https://github.com/instructure/ic-ajax">ic-ajax</a>. Feel free to use other mocking libraries such as <a href="https://github.com/appendto/jquery-mockjax">Mockjax</a>, but it&#39;s important to note, that Mockjax and other libraries are unaware of the run loop and won&#39;t wrap their resolve in a run call.  This may resolve in promises being run outside the realm of the run loop and will result in errors.</p>
<h3 class='anchorable-toc' id='toc_ic-ajax'>ic-ajax</h3>
<p>[ic-ajax] is an Ember-friendly <code>jQuery-ajax</code> wrapper, which is very convenient for building up fixture data and mocking ajax calls for unit/integration testing. The most common use case for promises is when you&#39;re making an asynchronous call to a server, and ic-ajax can help alleviate having to worry about wrapping <code>resolve</code> in a run call.</p>
<h4 class='anchorable-toc' id='toc_simple-ic-ajax-example'>Simple ic-ajax example:</h4>
<p>Imagine you wanted to request a list of colors from a server.  Using ic-ajax you would use the following syntax</p>
<div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>var promise = ic.ajax.request('/colors');
</pre></td>
</tr></table>
</div></div>
<p>This is an asynchronous call which returns a promise. When the promise has resolved, it will contain the list of colors. The convenient thing about ic-ajax is that it wraps the resolve of your ajax call in a call to Ember.run so you don&#39;t need to worry about it. We&#39;re going to set up some fixture data that can be returned instead of making an ajax call to fake the server so we can test our code</p>
<div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre>ic.ajax.defineFixture('/colors', {
  response: [
    {
      id: 1,
      color: &quot;red&quot;
    },
    {
      id: 2,
      color: &quot;green&quot;
    },
    {
      id: 3,
      color: &quot;blue&quot;
    }
  ],
  jqXHR: {},
  textStatus: 'success'
});
</pre></td>
</tr></table>
</div></div>
<p><a class="jsbin-embed" href="http://jsbin.com/OxIDiVU/366/embed?js,output">Using ic-ajax</a></p>
<h4 class='anchorable-toc' id='toc_simple-ic-ajax-example-with-ember-data'>Simple ic-ajax example with Ember Data:</h4>
<p>Ember Data can be dealt with just as easily, you will just need to define the fixtures in the same format that Ember Data is expecting it.</p>

<p><a class="jsbin-embed" href="http://emberjs.jsbin.com/OxIDiVU/361/embed?js,output">Using ic-ajax</a></p>
<h4 class='anchorable-toc' id='toc_integration-test-using-ic-ajax-and-ember-data'>Integration test using ic-ajax and Ember Data</h4>
<p>Often while doing integration tests, you don&#39;t actually want to hit the server because its state won&#39;t be consistent. Using the previously established patterns you can set up fixture data which will be returned in place of real ajax call responses so you can isolate your code as being the only thing under test. Below we&#39;e provided you with a simple example test using ic-ajax and Ember Data.</p>

<p><a class="jsbin-embed" href="http://emberjs.jsbin.com/OxIDiVU/365/embed?js,output">Using ic-ajax</a></p>
<h3 class='anchorable-toc' id='toc_jquery-mockjax'>jquery-mockjax</h3>
<p><a href="https://github.com/appendto/jquery-mockjax">jquery-mockjax</a> is a <code>jQuery</code> plugin that provides the ability to simulate ajax requests.</p>
<h4 class='anchorable-toc' id='toc_simple-jquery-mockjax-example'>Simple jquery-mockjax example:</h4>
<p>Imagine you wanted to request a list of colors from a server.  Using vanilla <code>jQuery</code> you would use the following syntax</p>
<div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>$.getJSON('/colors', function(response){ /* ... */ });
</pre></td>
</tr></table>
</div></div>
<p>This is an asynchronous call which will pass the server&#39;s response to the callback provided. Unlike <code>ic-ajax</code>, with vanilla <code>jQuery</code> you need to wrap the callback syntax in a promise.</p>
<div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre>var promise = new Ember.RSVP.Promise(function(resolve){
  $.getJSON('/colors', function(data){
    resolve(data.response);
  });
});
</pre></td>
</tr></table>
</div></div>
<p>We&#39;re going to set up some fixture data that can be returned instead of making an ajax call to fake the server so we can test our code</p>
<div class="highlight  "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
</pre></td>
  <td class="code"><pre>$.mockjax({
  type: 'GET',
  url: '/colors',
  status: '200',
  dataType: 'json',
  responseText: {
    response: [
      {
        id: 1,
        color: &quot;red&quot;
      },
      {
        id: 2,
        color: &quot;green&quot;
      },
      {
        id: 3,
        color: &quot;blue&quot;
      }
     ]
  }
});
</pre></td>
</tr></table>
</div></div>
<p>As you can see, there is a lot of flexibility in the <code>jquery-mockjax</code> api. You can specify not only the url and the response but the method, status code and data type. For the full jquery-mockax api check <a href="https://github.com/appendto/jquery-mockjax">their docs</a>.</p>

<p><a class="jsbin-embed" href="http://emberjs.jsbin.com/wotib/1/embed?js,output">Using jquery-mockjax</a></p>
<h4 class='anchorable-toc' id='toc_simple-jquery-mockjax-example-with-ember-data'>Simple jquery-mockjax example with Ember Data:</h4>
<p>Ember Data can be dealt with just as easily. You will just need to define the fixtures in the format that Ember Data is expecting.</p>

<p><a class="jsbin-embed" href="http://emberjs.jsbin.com/vojas/5/embed?js,output">Using jquery-mockjax</a></p>
<h4 class='anchorable-toc' id='toc_integration-test-using-jquery-mockjax-and-ember-data'>Integration test using jquery-mockjax and Ember Data</h4>
<p>Often while writing integration tests, you don&#39;t actually want to hit the server because its state won&#39;t be consistent. Using the previously established patterns you can set up fixture data which will be returned in place of real ajax call responses so you can isolate your code as being the only thing under test. Below we&#39;ve provided you with a simple example test using jquery-mockjax and Ember Data.</p>

<p><a class="jsbin-embed" href="http://emberjs.jsbin.com/hoxub/5/embed?js,output">Using jquery-mockjax</a></p>

    
      <footer>
        
          <a class="previous-guide" href="../guides/enumerables/index">
             ← Enumerables: Introduction
          </a>
         
            <a class="next-guide" href="../guides/configuring-ember/disabling-prototype-extensions">
               We're done with Testing. Next up: Configuring Ember.js - Disabling Prototype Extensions →
            </a>
          
      </footer>
      
  </div>

      </div>
    </div>

    <div id="footer">
      <div id="footer-wrapper">
        <div class="info">
          Copyright 2015 <a href="http://tilde.io">Tilde Inc.</a><br>
          <a href="/team">Core Team</a> | <a href="/sponsors">Sponsors</a> | <a href="/legal">Legal</a></br>
          <a href="/guidelines">Community Guidelines</a>
        </div>
        <div class="statement">Ember.js is free, open source and always will be.</div>
        <div class="links">
          <a class="twitter" href="http://twitter.com/emberjs">
            <i class="icon-twitter"></i><span>Twitter</span>
          </a>
          <a class="github" href="https://github.com/emberjs/ember.js">
            <i class="icon-github"></i><span>GitHub</span>
          </a>
          <a class="googleplus" href="https://plus.google.com/communities/106387049790387471205">
            <i class="icon-gplus"></i><span>Google+</span>
          </a>
        </div>
      </div>
    </div>

        <script type="text/javascript" src="/javascripts/guides.js"></script>
    <script src="http://static.jsbin.com/js/embed.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      var pluginUrl = '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
      _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
      _gaq.push(['_setAccount', 'UA-27675533-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
